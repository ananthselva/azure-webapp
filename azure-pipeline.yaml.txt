

trigger:
  - main 

pool:
  vmImage: "Ubuntu 20.04.6 LTS" 

stages: 
- stage: Build
  jobs:
  - job: Build
    displayName: "Install npm packages and Build"
    workspace:
      clean: all
    steps:
      - checkout: self
        submodules: true
      - task: NodeTool@0
        inputs:
          versionSpec: '14.x'
          checkLatest: true
        displayName: 'Install Node.js'

      - script: |
          npm install
        displayName: 'Install dependencies'
      
      - script: |
          npm run build
        displayName: 'Build'

      - task: CopyFiles@2
        inputs:
          SourceFolder: '$(System.DefaultWorkingDirectory)/build'
          Contents: '**'
          TargetFolder: '$(Build.ArtifactStagingDirectory)'
          OverWrite: true
        displayName: 'Copy build files to artifacts'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'drop'
          publishLocation: 'Container'
        displayName: 'Publish Artifact'

- stage: Deploy
  jobs:
    - job: Deploy
      displayName: Deploying
      steps:
      - task: DownloadPipelineArtifact@2
        inputs:
          source: 'current'
          artifact: 'drop'
          path: '$(Pipeline.Workspace)'

      - task: AzureRmWebAppDeployment@4
        inputs:
          ConnectionType: 'AzureRM' 
          azureSubscription: '94581167-9799-4165-bc6d-2005e189b1d8'
          appType: 'webapp'  
          WebAppName: 'toy-01' 
          packageForLinux: '$(Pipeline.Workspace)'